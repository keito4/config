name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # CIが完了しているかチェック
  check-ci-status:
    runs-on: ubuntu-latest
    timeout-minutes: 20 # CIの完了を待つため延長
    outputs:
      ci_passed: ${{ steps.check.outputs.ci_passed }}
    permissions:
      contents: read
      pull-requests: read
      checks: read
    steps:
      - name: Wait for CI and check status
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO="${{ github.repository }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          echo "Waiting for CI to complete for PR #$PR_NUMBER (SHA: $HEAD_SHA)"

          # ポーリング設定
          MAX_WAIT_TIME=900  # 15分（秒）
          POLL_INTERVAL=30   # 30秒
          ELAPSED_TIME=0

          while [ $ELAPSED_TIME -lt $MAX_WAIT_TIME ]; do
            echo "⏱️  Elapsed time: ${ELAPSED_TIME}s / ${MAX_WAIT_TIME}s"

            # Check Runsを取得（CI workflowのみ）
            CHECK_RUNS=$(gh api repos/$REPO/commits/$HEAD_SHA/check-runs \
              --jq '.check_runs[] | select(.name != "check-ci-status" and .name != "claude-review") | {name, status, conclusion}')

            echo "Check Runs:"
            echo "$CHECK_RUNS" | jq -r '"\(.name): \(.status) - \(.conclusion)"'

            # 必須チェック: Quality Gate
            QUALITY_GATE=$(echo "$CHECK_RUNS" | jq -r 'select(.name == "Quality Gate")')

            if [ -z "$QUALITY_GATE" ]; then
              echo "⏳ Quality Gate check has not started yet, waiting..."
              sleep $POLL_INTERVAL
              ELAPSED_TIME=$((ELAPSED_TIME + POLL_INTERVAL))
              continue
            fi

            QUALITY_GATE_STATUS=$(echo "$QUALITY_GATE" | jq -r '.status')
            QUALITY_GATE_CONCLUSION=$(echo "$QUALITY_GATE" | jq -r '.conclusion')

            if [ "$QUALITY_GATE_STATUS" != "completed" ]; then
              echo "⏳ Quality Gate is still running: $QUALITY_GATE_STATUS, waiting..."
              sleep $POLL_INTERVAL
              ELAPSED_TIME=$((ELAPSED_TIME + POLL_INTERVAL))
              continue
            fi

            # Quality Gate完了 - 結果を確認
            if [ "$QUALITY_GATE_CONCLUSION" != "success" ]; then
              echo "ci_passed=false" >> $GITHUB_OUTPUT
              echo "❌ Quality Gate failed with conclusion: $QUALITY_GATE_CONCLUSION"
              echo "Claude Code Review will be skipped."
              exit 0
            fi

            # すべての実行されたチェック（skippedでないもの）を確認
            FAILED_CHECKS=$(echo "$CHECK_RUNS" | jq -r 'select(.status == "completed" and .conclusion != "success" and .conclusion != "skipped" and .conclusion != "neutral")')

            if [ -n "$FAILED_CHECKS" ]; then
              echo "ci_passed=false" >> $GITHUB_OUTPUT
              echo "❌ Some CI checks failed:"
              echo "$FAILED_CHECKS" | jq -r '"\(.name): \(.conclusion)"'
              echo "Claude Code Review will be skipped."
              exit 0
            fi

            # すべてのチェックが成功
            echo "ci_passed=true" >> $GITHUB_OUTPUT
            echo "✅ All CI checks passed"
            exit 0
          done

          # タイムアウト
          echo "ci_passed=false" >> $GITHUB_OUTPUT
          echo "⏱️ Timeout: CI did not complete within ${MAX_WAIT_TIME}s"
          echo "Claude Code Review will be skipped."
          exit 0

  claude-review:
    # CIが成功した場合のみ実行
    if: needs.check-ci-status.outputs.ci_passed == 'true'
    needs: [check-ci-status]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
