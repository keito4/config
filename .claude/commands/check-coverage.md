# check-coverage

## 目的

テストカバレッジが全リポジトリ70%以上、クリティカルパス100%の基準を満たしているか確認する。カバレッジの詳細レポートを生成し、改善点を特定。

## 実行手順

1. **カバレッジの測定**

   ```bash
   # カバレッジ付きでテストを実行
   npm run test -- --coverage
   ```

2. **カバレッジサマリの確認**

   ```bash
   # コンソールでサマリを表示
   npm run coverage:summary
   ```

3. **詳細レポートの生成**

   ```bash
   # HTMLレポートを生成
   npm run coverage:html

   # レポートの場所を表示
   echo "Coverage report: ./coverage/lcov-report/index.html"
   ```

4. **クリティカルパスの確認**

   ```bash
   # クリティカルパスのリストを確認
   echo "クリティカルパス:"
   echo "- 認証/認可関連機能"
   echo "- 決済処理"
   echo "- セキュリティ関連機能"
   echo "- データの保存/削除処理"
   echo "- エラーハンドリング"
   ```

5. **カバレッジが低いファイルの特定**

   ```bash
   # カバレッジが50%未満のファイルをリスト
   npm run coverage:low-files
   ```

6. **カバレッジレポートのCI用出力**

   ```bash
   # CI用のJUnit形式で出力
   npm run coverage:ci
   ```

7. **カバレッジ履歴の確認**
   ```bash
   # 過去のカバレッジと比較
   git show HEAD~1:coverage/coverage-summary.json 2>/dev/null || echo "履歴なし"
   ```

## 成功基準

- ✅ 全体のラインカバレッジが70%以上
- ✅ ブランチカバレッジが60%以上
- ✅ 関数カバレッジが65%以上
- ✅ クリティカルパスのカバレッジが100%
- ✅ カバレッジレポートが正常に生成される

## トラブルシューティング

### カバレッジが基準を満たさない場合

1. HTMLレポートで未カバーのコードを確認
2. 優先度順にテストを追加:
   - クリティカルパス > ビジネスロジック > ユーティリティ
3. テストが難しいコードはリファクタリングを検討

### カバレッジが測定されない場合

1. `jest.config.js` またはテスト設定を確認
2. `collectCoverageFrom` の設定を確認
3. テストが実行されているか確認

### クリティカルパスの特定が難しい場合

1. ビジネス要件を確認
2. セキュリティチームと連携
3. リスクアセスメントを実施
4. `.critical-paths.json` ファイルで明示的に定義

### カバレッジの向上方法

1. TDDを徹底（テストファースト）
2. モックを活用して依存関係を分離
3. エッジケースのテストを追加
4. カバレッジ目標を段階的に設定（60% → 70% → 80%）
